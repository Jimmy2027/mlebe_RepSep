\section{Evaluation}

%We evaluate the quality of the registration both in terms of spatial features, as well as in terms of its repercussion on higher-level functional analysis.

A challenge of QC with regard to spatial features is that a perfect mapping to the template is undefined.
Similarity metrics are ill-suited for QC because they are used internally by registration functions, whose main feature it is, that they maximize them.
Indeed extreme maximization, especially via nonlinear transformations, results in distortion of the image, which should be penalized in QC, but in light of image similarity scores is represented as better performance.
Additionally, similarity metrics are not independent, so this issue cannot be circumvented by maximizing a subset of metrics and performing QC via the remainder.
%We thus develop three alternative evaluation metrics: volume conservation, functional analysis, and variance analysis.
We thus develop two alternative evaluation metrics: volume conservation and functional analysis.
In order to mitigate possible differences arising from qualitative template features, we perform a multivariate analysis of both templates and workflows.

\subsection{Volume Conservation}

Volume conservation is based on the assumption that the total volume of the scanned segment of the brain should remain approximately identical after registration.
A volume increase may indicate that the brain was stretched to fill in template brain space not covered by the scan, while a volume decrease might indicate that non-brain voxels were introduced into the template brain space.

In order to best analyze volume conservation, a Volume Change Factor (VCF) is computed for each processed scan, whereby volume conservation is highest for a VCF equal to 1.
For the current implementation we define brain volume as estimated by the 66\textsuperscript{th} voxel intensity percentile of the unregistered scan.
The arbitrary unit equivalent of this percentile threshold is recorded for each scan and applied to all registration workflow results for that particular scan, to obtain VCF esimates
 --- detailed in \cref{eq:vcf}, where $v$ is the voxel volume in the original space, $v^\prime$ the voxel volume in the transformed space, $n$ the number of voxels in the original space, $m$ the number of voxels in the transformed space, $s$ a voxel value sampled from the vector $S$ containing all values in the original data, and $s^\prime$ a voxel value sampled from the transformed data.

\begin{equation} \label{eq:vcf}
        V\!C\!F
        = \frac{v^\prime\sum_{i=1}^m [s^\prime_i \geq P_{66}(S)]}{v\sum_{i=1}^n [s_i \geq P_{66}(S)]}
        = \frac{v^\prime\sum_{i=1}^m [s^\prime_i \geq P_{66}(S)]}{v \lceil0.66n\rceil}
\end{equation}

\begin{sansmath}
\py{pytex_subfigs(
        [
                {'script':'scripts/vc_violin.py', 'label':'vcv', 'conf':'article/1col.conf', 'options_pre':'{.48\\textwidth}',
			'caption':'Comparison across workflows and target templates, considering both BOLD and CBV functional contrasts.'
                        ,},
                {'script':'scripts/vcc_violin.py', 'label':'vccv','conf':'article/1col.conf', 'options_pre':'{.48\\textwidth}',
                        'caption':'Comparison across workflows and functional contrasts, considering only matching template-workflow combinations.'
                        ,},
                ],
        caption='\\textbf{SAMRI Generic processed data optimally and reliably conserves scan volume --- unlike the Legacy workflow.}
        The coloured patch width estimates distribution density, while solid lines indicate the sample mean and dashed lines indicate the inner quartiles.',
        label='fig:vc',
        )}
\end{sansmath}

As seen in \cref{fig:vcv}, we note that VCF is sensitive to
the processing workflow (\py{boilerplate.fstatistic('Processing', condensed=True)}),
the template (\py{boilerplate.fstatistic('Template', condensed=True)}),
but not the interaction thereof (\py{boilerplate.fstatistic('Processing:Template', condensed=True)}).

The performance of the Generic SAMRI workflow (with the Generic template) is significantly different from that of the Legacy workflow (with the Legacy template), yielding a two-tailed p-value of \py{pytex_printonly('scripts/vc_t.py')}).
Additionally, the root mean squared error ratio strongly favours the Generic workflow
($\mathrm{RMSE_{L}/RMSE_{G}\simeq} \py{pytex_printonly('scripts/vc_rmser.py')}$).

Descriptively, we observe that the effect with the greatest magnitude is that of the template variable, with its Legacy level introducing a notable volume loss
(VCF of \py{boilerplate.factorci('Template[T.Legacy]')}).
Further, we note that there is a variance increase in all conditions for the Legacy processing workflow
(\py{boilerplate.varianceratio(template='Legacy')}-fold given the Legacy template, and \py{boilerplate.varianceratio(template='Generic')}-fold given the Generic template).

With respect to the data break-up by contrast (from \cref{fig:vccv}), we see no notable main effect for the contrast variable
(VCF of \py{boilerplate.corecomparison_factorci('Contrast[T.CBV]')}).
We do, however, report a notable effect for the contrast-template interaction, with the Legacy workflow and CBV contrast interaction level introducing a volume loss
(VCF of \py{boilerplate.corecomparison_factorci('Processing[T.Legacy]:Contrast[T.CBV]')}).

\subsection{Functional Analysis}

Functional analysis is a viable avenue for registration QC, as the metric being maximized in the registration process is not the same metric used for QC.
This method is however primarily suited to examine workflow effects in light of higher-level applications, and less suited for wide-spread QC (as it is computationally intensive and only applicable to stimulus-evoked functional data).
As a first step we examine statistical power, via the negative logarithm of first-level p-value maps (i.e. voxelwise statistical estimates for the probability that each voxel time course is at least as well correlated with the stimulation regressor, by chance alone).
We compute the per-scan average of these values, which we term Mean Significance --- detailed in \cref{eq:ms}, where $n$ represents the number of statistical estimates in the scan, and $p$ is a p-value.

\begin{equation} \label{eq:ms}
        M\!S = \frac{\sum_{i=1}^n -log(p_i)}{n}
\end{equation}

\begin{sansmath}
\py{pytex_subfigs(
        [
                {'script':'scripts/ms_violin.py', 'label':'msv', 'conf':'article/1col.conf', 'options_pre':'{.48\\textwidth}',
			'caption':'Comparison across workflows and target templates, considering both BOLD and CBV functional contrasts.'
                        ,},
                {'script':'scripts/msc_violin.py', 'label':'mscv','conf':'article/1col.conf', 'options_pre':'{.48\\textwidth}',
                        'caption':'Comparison across workflows and functional contrasts, considering only matching template-workflow combinations.'
                        ,},
                ],
        caption='\\textbf{Per-scan significance from functional analysis does not indicate registration quality.}
                The coloured patch width estimates distribution density, while continuous markers indicate the sample mean and dashed markers indicate the inner quartiles.',
        label='fig:ms',)}
\end{sansmath}

As seen in \cref{fig:ms}, MS is sensitive to neither the processing workflow
(\py{boilerplate.fstatistic('Processing', dependent_variable='Mean Significance', df_path='data/functional_significance.csv', condensed=True)}),
nor the template
(\py{boilerplate.fstatistic('Template', dependent_variable='Mean Significance', df_path='data/functional_significance.csv', condensed=True)}),
nor the interaction thereof
(\py{boilerplate.fstatistic('Processing:Template', dependent_variable='Mean Significance', df_path='data/functional_significance.csv', condensed=True)}).

The Generic SAMRI workflow (with the Generic template) is not significantly different from that of the Legacy workflow (with the Legacy template), yielding a two-tailed p-value of \py{pytex_printonly('scripts/ms_t.py')}.
There is again a variance increase in all conditions for the Legacy processing workflow
(\py{boilerplate.varianceratio(df_path='data/functional_significance.csv', template='Legacy', dependent_variable='Mean Significance')}-fold
given the Legacy template, and
\py{boilerplate.varianceratio(df_path='data/functional_significance.csv', template='Generic', dependent_variable='Mean Significance')}-fold
given the Generic template).

With respect to the data break-up by contrast (from \cref{fig:mscv}), we see no notable positive main effect for the contrast variable
(MS of
\py{boilerplate.corecomparison_factorci('Contrast[T.CBV]', df_path='data/functional_significance.csv', dependent_variable='Mean Significance')}).
We do, however, report a notable effect for the contrast-template interaction, with the Legacy workflow and CBV contrast interaction level introducing a significance increase
(MS of
\py{boilerplate.corecomparison_factorci('Processing[T.Legacy]:Contrast[T.CBV]', df_path='data/functional_significance.csv', dependent_variable='Mean Significance')}).

Overall statistical power is, however, independent of the mapping accuracy, and functional analysis effects can be further inspected by visualizing the statistic maps.
For a succint overview capturing both amplitude and directionality of the signal, we present second-level t-statistic maps depicting the CBV and BOLD omnibus contrasts (across subjects and sessions) in \cref{fig:m}.
While the most salient feature of this figure is the qualitative distribution difference between CBV and BOLD scans, we note that this is to be expected given the different nature of the processes.
More relevant to registration quality is the differential coverage.
We note that the Legacy template induces coverage overflow, extending to the cerebellum (\cref{fig:mglc,fig:mllc,fig:mllb}), and to the olfactory bulbs when used in conjunction with the Legacy workflow (\cref{fig:mllc,fig:mllb}).
Separately from the Legacy template, the Legacy workflow causes coverage overflow (both rostrally into the base of the olfactory bulbs and caudally into the cerebellum) even when used in conjunction with the Generic template (\cref{fig:mlgc,fig:mlgb}).
Positive activation of the Raphe system, most clearly disambiguated from the surrounding tissue in the BOLD contrast, is notably displaced very far caudally by the joint effects of the Legacy workflow and the Legacy template (\cref{fig:mllb}).
We note that processing with the Generic template the Generic workflow (\cref{fig:mggc,fig:mggb}), do not show issues of statistic coverage.

\py{pytex_subfigs(
	[
		{'script':'scripts/map_generic_cbv.py', 'label':'mggc', 'conf':'article/map.conf', 'options_pre':'{.48\\textwidth}',
			'caption':'
                                Generic workflow with Generic template CBV map, showing correct slice orientation and coverage correctly bounded to the acquisition area.
                                '
			,},
		{'script':'scripts/map_generic_ambmc_cbv.py', 'label':'mglc','conf':'article/map.conf', 'options_pre':'{.48\\textwidth}',
			'caption':'
                                Generic workflow with Legacy template CBV map, showing incorrect slice orientation and coverage caudally extending beyond the acquisition area.
                                '
			,},
		{'script':'scripts/map_legacy_dsurqec_cbv.py', 'label':'mlgc','conf':'article/map.conf', 'options_pre':'{.48\\textwidth}',
			'caption':'
                                Legacy workflow with Generic template CBV map, showing correct slice orientation and coverage caudally extending beyond the acquisition area.
                                '
			,},
		{'script':'scripts/map_legacy_cbv.py', 'label':'mllc','conf':'article/map.conf', 'options_pre':'{.48\\textwidth}',
			'caption':'
				Legacy workflow with Legacy template CBV map, showing incorrect slice orientation and coverage both caudally and rostrally extending beyond acquisition area.
				'
			,},
		{'script':'scripts/map_generic_bold.py', 'label':'mggb', 'conf':'article/map.conf', 'options_pre':'{.48\\textwidth}',
			'caption':'
                                Generic workflow with Generic template BOLD map, showing correct slice orientation and coverage correctly bounded to the acquisition area.
                                '
			,},
		{'script':'scripts/map_generic_ambmc_bold.py', 'label':'mglb','conf':'article/map.conf', 'options_pre':'{.48\\textwidth}',
			'caption':'
                                Generic workflow with Legacy template BOLD map, showing incorrect slice orientation and coverage correctly bounded to the acquisition area.
                                '
			,},
		{'script':'scripts/map_legacy_dsurqec_bold.py', 'label':'mlgb','conf':'article/map.conf', 'options_pre':'{.48\\textwidth}',
			'caption':'
                                Legacy workflow with Generic template BOLD map, showing correct slice orientation and coverage caudally extending beyond acquisition area.
                                '
			,},
		{'script':'scripts/map_legacy_bold.py', 'label':'mllb','conf':'article/map.conf', 'options_pre':'{.48\\textwidth}',
			'caption':'
				Legacy workflow with Legacy template BOLD map, showing incorrect slice orientation and coverage both caudally and rostrally extending beyond acquisition area.
			        '
                        ,},
		],
	caption='
                \\textbf{Legacy processing leads to a problematic overflow of the statistical-maps into adjacent anatomical regions, leaking beyond the acquistion area.}
                SAMRI mitigates this effect as illustrated by multiplanar depictions of mouse brain templates, with the corresponding second-level omnibus statistic maps separately evaluating CBV and BOLD scans, and thresholded at $\mathrm{|t|\geq2}$.
                The acquisition area is bracketed in pink, and in comparing it to statistic coverage it is important to note that the spatial coverage of the latter is slightly underestimated, as the omnibus contrast is only defined for voxels captured in \\textit{every} evaluated scan.
                ',
	label='fig:m',)}

\subsection{Variance analysis}

\begin{sansmath}
\py{pytex_fig('scripts/variance_catplot.py',
        conf='article/varplot.conf',
        label='var',
        caption='
                \\textbf{The SAMRI Generic workflow decreases the across session variance per subject compared to the Legacy workflow.}
                Swarmplots illustrate similarity metric scores of registered images with respect to the corresponding workflow template, plotted across subjects (separated into x-axis bins) and sessions (individual points in each x-axis bin).
                ',
        multicol=True,
        )}
\end{sansmath}

Another way to assess registration quality is by looking at how much of the total variance of registered samples is explained by either subject or session across different similarity measures:
Crosscorrelation (CC), Mutual Information (MI), and Global Correlation(GC).
Since adult mouse brains in the absence of intervention are assumed to retain size and shape across the 8 week study period, more variation should be found across sessions rather than subjects.
This comparison can be performed using a type 3 ANOVA, modelling both the subject and the session variables.
As similarity metrics are not equivalent, and since the main comparison of variance is performed across al of them, p-values for the variable effects are uncorrected.

\Cref{fig:var} renders the similarity metric scores for both the SAMRI Generic and Legacy workflows (considering only the matching workflow-template combinations).
We can see that MI between the Legacy workflow results and the corresponding template is significantly influenced by the session variable (\py{boilerplate.variance_test('C(Session)','Legacy','MI', condensed=True)}) but not the subject variable (\py{boilerplate.variance_test('C(Subject)','Legacy','MI', condensed=True)}).
For the other metrics, we find neither the session nor the subject variable significant, although the F-statistic is higher for the subject than for the session variable using both
the CC metric (subject: \py{boilerplate.variance_test('C(Subject)','Legacy','CC', condensed=True)}, session: \py{boilerplate.variance_test('C(Session)','Legacy','CC', condensed=True)})
and the GC metric (subject: \py{boilerplate.variance_test('C(Subject)','Legacy','GC', condensed=True)}, session: \py{boilerplate.variance_test('C(Session)','Legacy','GC', condensed=True)}).
Looking at the generic SAMRI workflow we find the opposite effect.
Across metrics, F-statistics for the subject variable are consistently higher than for the session variable:
CC (subject: \py{boilerplate.variance_test('C(Subject)','Generic','CC', condensed=True)}, session: \py{boilerplate.variance_test('C(Session)','Generic','CC', condensed=True)}),
GC (subject: \py{boilerplate.variance_test('C(Subject)','Generic','GC', condensed=True)}, session: \py{boilerplate.variance_test('C(Session)','Generic','GC', condensed=True)}),
and MI (subject: \py{boilerplate.variance_test('C(Subject)','Generic','MI', condensed=True)}, session: \py{boilerplate.variance_test('C(Session)','Generic','MI', condensed=True)}).
Notably, in the CC metric, the subject-wise variance reaches significance, but not the session-wise variance.

\subsection{Smoothness Conservation}

\begin{sansmath}
\py{pytex_subfigs(
        [
                {'script':'scripts/scf_violin_templates.py', 'label':'scv', 'conf':'article/1col.conf', 'options_pre':'{.48\\textwidth}',
                        'caption':'Comparison across workflows and target templates, considering both BOLD and CBV functional contrasts.'
                        ,},
                {'script':'scripts/scf_violin_contrasts.py', 'label':'sccv','conf':'article/1col.conf', 'options_pre':'{.48\\textwidth}',
                        'caption':'Comparison across workflows and functional contrasts, considering only matching template-workflow combinations.'
                        ,},
                ],
        caption='
                \\textbf{SAMRI Generic registration does not increase spatial smoothing, thereby increasing locality of functional analysis results.}
                Smoothness change relative to the original scan, presented on a log scale due to considerable effect size in the comparison between workflows.
                The coloured patch width estimates distribution density, while continuous markers indicate the sample mean and dashed markers indicate the inner quartiles.
                ',
        label='fig:sc',
        )}
\end{sansmath}

The final metric we consider is the smoothness of the image after registration.
Although smoothing can lead to an increase in signal-to-noise ratio (SNR), it does decrease spatial resolution and is therefore associated with less anatomically aligned images and statistical maps \cite{fmriprep}.
Thus we employ --- analogously to the Volume Change Factor --- a Smoothness Change Factor (SCF) which normalizes the smoothness of the registered images with respect to the smoothness of the original images.
Our smoothness measure is the full-width at half-maximum (FWHM).
Since fMRI data usually does not have a gaussian-shaped spatial autocorrelation (ACF \cite{eklund2016cluster}, \cite{cox2017fmri}), we fit the following function to the data in order to estimate the FWHM using AFNI \cite{cox1996afni}.

\begin{equation} \label{eq:acf}
        ACF(r)
        = a * e^{ -r^{2}/ (2 * b^{2}) } + (1 - a) + e^{-r/c}
\end{equation}

Since we introduce the VCF and SCF in a similar fashion, we analyze them similarly as well. The SCF is significantly different from 1 after processing with both the Legacy ($p= $\py{pytex_printonly('scripts/scf_t_legacy.py')}) and the Generic workflow ($p= $\py{pytex_printonly('scripts/scf_t_generic.py')}).
The amplitude of this distortion is however notably higher for the Legacy (\py{boilerplate.meanVar('mean', Processing='Legacy')}$\pm$\py{boilerplate.meanVar('sd', Processing='Legacy')}), than for the Genericworkflow (\py{boilerplate.meanVar('mean', Processing='Generic')}$\pm$\py{boilerplate.meanVar('sd', Processing='Generic')}).
Additionally, the root mean squared error ratio strongly favours the Generic workflow ($\mathrm{RMSE_{L}/RMSE_{G}\simeq} \py{pytex_printonly('scripts/scf_rmser.py')}$).
Similarly to the VCF, we see no notable main effect for the contrast variable (\cref{fig:sccv}) (SCF of \py{boilerplate.corecomparison_factorci('Contrast[T.CBV]', df_path='data/smoothness_data.csv', dependent_variable='Smoothness Change Factor')}).
We observe a notable effect for the CBV contrast-Legacy template interaction, introducing an increase in SCF (SCF of \py{boilerplate.corecomparison_factorci('Processing[T.Legacy]:Contrast[T.CBV]', df_path='data/smoothness_data.csv', dependent_variable='Smoothness Change Factor')}).
Moreover, the Legacy workflow produces a substantial increase in SCF variance compared to the Generic workflow (\py{boilerplate.varianceratio(df_path='data/smoothness_data.csv',dependent_variable='Smoothness Change Factor', max_len=3, template='Legacy')}-fold for the Legacy template and \py{boilerplate.varianceratio(df_path='data/smoothness_data.csv',dependent_variable='Smoothness Change Factor', template='Generic', max_len=3)}-fold for the Generic template).
